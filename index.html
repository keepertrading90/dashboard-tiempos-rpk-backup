<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPK | Dashboard Ejecutivo de Producci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --rpk-red: #E30613;
            --rpk-red-dark: #B00510;
            --dark-bg: #121212;
            --dark-surface: #1E1E1E;
            --dark-surface-2: #2A2A2A;
            --text-main: #FFFFFF;
            --text-muted: #B0B0B0;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE and Edge */
        }

        /* Ocultar barra de desplazamiento para Chrome, Safari y Opera */
        ::-webkit-scrollbar {
            display: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-main);
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            min-width: 220px;
            background-color: var(--dark-surface);
            border-right: 1px solid var(--glass-border);
            padding: 1.5rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo-container {
            margin-bottom: 2rem;
        }

        .logo-container img {
            max-width: 120px;
            height: auto;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover {
            background-color: var(--dark-surface-2);
            color: var(--text-main);
        }

        .nav-item.active {
            background-color: var(--rpk-red);
            color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 220px;
            padding: 1.5rem 2rem;
            min-height: 100vh;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-header h1 {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .date-badge {
            background: var(--glass-bg);
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: flex-end;
            background: var(--dark-surface);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .filter-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-bar select,
        .filter-bar input[type="date"] {
            background: var(--dark-surface-2);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            min-width: 140px;
        }

        .filter-bar select[multiple] {
            height: 100px;
            padding: 0.5rem;
            min-width: 250px;
        }

        .filter-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            background: var(--dark-surface-2);
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            border-color: var(--text-muted);
            color: var(--text-main);
        }

        .btn {
            background: var(--rpk-red);
            color: white;
            border: none;
            padding: 0.5rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn:hover {
            background: var(--rpk-red-dark);
        }

        .btn-secondary {
            background: var(--dark-surface-2);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: var(--glass-border);
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: var(--dark-surface);
            padding: 1rem 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--rpk-red);
        }

        .kpi-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.4rem;
        }

        .kpi-value {
            font-size: 1.6rem;
            font-weight: 700;
        }

        /* Charts Grid */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .charts-row.single {
            grid-template-columns: 1fr;
        }

        .chart-box {
            background: var(--dark-surface);
            padding: 1rem 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }

        .chart-box h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        /* Table */
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .ranking-table th {
            text-align: left;
            padding: 0.5rem;
            color: var(--text-muted);
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
        }

        .ranking-table td {
            padding: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .ranking-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Estilos para filas expandibles */
        .row-expandable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .row-expandable:hover {
            background: rgba(227, 6, 19, 0.05) !important;
        }

        .expand-icon {
            display: inline-block;
            transition: transform 0.3s;
            margin-right: 8px;
            color: var(--rpk-red);
            font-size: 0.7rem;
        }

        .expanded .expand-icon {
            transform: rotate(90deg);
        }

        .child-row {
            background: rgba(0, 0, 0, 0.2);
        }

        .child-container {
            padding: 0 1rem 1rem 3rem;
        }

        .article-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            overflow: hidden;
        }

        .article-table th {
            background: var(--dark-surface-2);
            padding: 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        .article-table td {
            padding: 0.4rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .article-table tr:last-child td {
            border-bottom: none;
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--dark-surface);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--glass-border);
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--rpk-red);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.4s;
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #1e1e1e;
            border-bottom-color: var(--rpk-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div id="loader" class="loading-overlay">
        <span class="loader"></span>
    </div>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo-container">
                <img src="rpk_logo.png" alt="RPK Group Logo">
            </div>
            <nav>
                <div class="nav-item active" data-section="dashboard">üìä Dashboard</div>
                <div class="nav-item" data-section="evolution">üìà Evoluci√≥n Centros</div>
                <div class="nav-item" data-section="settings">‚öôÔ∏è Ajustes</div>
            </nav>
        </aside>

        <main class="main-content">
            <!-- SECTION: Dashboard Principal -->
            <div id="section-dashboard" class="section active">
                <div class="page-header">
                    <div>
                        <h1>An√°lisis Centros Secundarios</h1>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.2rem;">An√°lisis Tiempos
                            Medios de Espera</p>
                    </div>
                    <div class="date-badge" id="last-update">√öltimo Dato: --</div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <span class="filter-label">Desde</span>
                        <input type="date" id="fecha-inicio">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Hasta</span>
                        <input type="date" id="fecha-fin">
                    </div>
                    <button class="btn" onclick="applyFilters()">Aplicar</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">Limpiar</button>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Carga Total</div>
                        <div class="kpi-value" id="kpi-total">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Media Carga</div>
                        <div class="kpi-value" id="kpi-media">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Centros Activos</div>
                        <div class="kpi-value" id="kpi-centros">0</div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-box">
                        <h3>Evoluci√≥n Diaria (Total Carga)</h3>
                        <canvas id="mainTrendChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>Top 5 Centros</h3>
                        <canvas id="centersDonutChart"></canvas>
                    </div>
                </div>

                <div class="charts-row single">
                    <div class="chart-box">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 id="multi-chart-title" style="margin-bottom: 0;">Evoluci√≥n por Centros Principales</h3>
                            <button id="reset-chart-btn" class="btn btn-secondary"
                                style="padding: 0.2rem 0.6rem; font-size: 0.7rem; display: none;"
                                onclick="resetToTop5Centers()">Reset Vista</button>
                        </div>
                        <canvas id="multiCenterChart"></canvas>
                    </div>
                </div>

                <div class="chart-box">
                    <h3>Ranking Top 15 - Centros de Trabajo</h3>
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Centro</th>
                                <th>Carga D√≠a</th>
                                <th>Media Mensual</th>
                                <th>Total Mes</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECTION: Evoluci√≥n por Centro -->
            <div id="section-evolution" class="section">
                <div class="page-header">
                    <div>
                        <h1>Evoluci√≥n por Centro</h1>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.2rem;">An√°lisis detallado
                            de un centro espec√≠fico</p>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group" style="align-items: flex-start;">
                        <span class="filter-label">Centros (Mant√©n Ctrl para varios)</span>
                        <select id="centro-select" multiple>
                            <!-- Se puebla din√°micamente -->
                        </select>
                        <div class="filter-controls">
                            <button class="btn-small" onclick="selectAllCentros()">Seleccionar Todos</button>
                            <button class="btn-small" onclick="clearCentros()">Limpiar</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Desde</span>
                        <input type="date" id="centro-fecha-inicio">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Hasta</span>
                        <input type="date" id="centro-fecha-fin">
                    </div>
                    <button class="btn" onclick="loadCentroData()">Ver Evoluci√≥n</button>
                </div>

                <div id="centro-content" style="display: none;">
                    <div class="stats-grid" id="centro-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="centro-total">0</div>
                            <div class="stat-label">Carga Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="centro-media">0</div>
                            <div class="stat-label">Media Diaria</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="centro-max">0</div>
                            <div class="stat-label">M√°ximo</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="centro-min">0</div>
                            <div class="stat-label">M√≠nimo</div>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-box">
                            <h3 id="centro-chart-title">Evoluci√≥n Diaria</h3>
                            <canvas id="centroEvolutionChart"></canvas>
                        </div>
                        <div class="chart-box">
                            <h3>Hist√≥rico Mensual</h3>
                            <canvas id="centroMonthlyChart"></canvas>
                        </div>
                    </div>

                    <div id="monthly-breakdown-container" style="display: none; margin-top: 1.5rem;">
                        <div class="chart-box">
                            <h3 id="monthly-breakdown-title">Desglose de Art√≠culos - Mes</h3>
                            <div id="monthly-breakdown-table-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: Ajustes -->
            <div id="section-settings" class="section">
                <div class="page-header">
                    <h1>Ajustes</h1>
                </div>
                <div class="chart-box">
                    <h3>Informaci√≥n del Sistema</h3>
                    <p style="color: var(--text-muted); line-height: 1.8;">
                        <strong>Versi√≥n:</strong> 2.0<br>
                        <strong>√öltimo dato:</strong> <span id="settings-last-update">-</span><br>
                        <strong>Total d√≠as:</strong> <span id="settings-total-records">-</span>
                    </p>
                    <button class="btn" onclick="location.reload()" style="margin-top: 1rem;">üîÑ Recargar Datos</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Estado global
        let globalData = null;
        let charts = {};

        // Verificar protocolo
        if (window.location.protocol === 'file:') {
            document.getElementById('loader').style.display = 'none';
            document.body.innerHTML = `
                <div style="background:#E30613;color:white;padding:3rem;text-align:center;font-family:'Inter',sans-serif;min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;">
                    <h1 style="font-size:2rem;margin-bottom:1rem;">‚ö†Ô∏è Acceso Incorrecto</h1>
                    <p style="font-size:1rem;max-width:500px;line-height:1.5;">
                        Has abierto el Dashboard como archivo local.<br>
                        Ejecuta <code style="background:#000;padding:0.3rem 0.6rem;border-radius:4px;">INICIAR_DASHBOARD.bat</code>
                    </p>
                </div>
            `;
        }

        // Navegaci√≥n
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                const section = this.dataset.section;
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById('section-' + section).classList.add('active');
            });
        });

        async function fetchData() {
            try {
                const centrosRes = await fetch('/api/centros');
                const centrosData = await centrosRes.json();
                populateCentrosSelect(centrosData.centros || []);

                const fechasRes = await fetch('/api/fechas');
                const fechasData = await fechasRes.json();
                if (fechasData.fecha_min && fechasData.fecha_max) {
                    document.getElementById('fecha-inicio').value = fechasData.fecha_min;
                    document.getElementById('fecha-fin').value = fechasData.fecha_max;
                    document.getElementById('centro-fecha-inicio').value = fechasData.fecha_min;
                    document.getElementById('centro-fecha-fin').value = fechasData.fecha_max;
                }

                await loadSummary();
            } catch (error) {
                console.error("Error:", error);
            } finally {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 400);
            }
        }

        async function loadSummary(fechaInicio = null, fechaFin = null) {
            let url = '/api/summary';
            const params = new URLSearchParams();
            if (fechaInicio) params.append('fecha_inicio', fechaInicio);
            if (fechaFin) params.append('fecha_fin', fechaFin);
            if (params.toString()) url += '?' + params.toString();

            const response = await fetch(url);
            const data = await response.json();

            if (data.error) { console.error(data.error); return; }

            globalData = data;
            updateDashboard(data);
        }

        function populateCentrosSelect(centros) {
            const select = document.getElementById('centro-select');
            select.innerHTML = '';
            centros.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `Centro ${c.id} (${c.carga_total.toLocaleString()}h)`;
                select.appendChild(opt);
            });
        }

        function selectAllCentros() {
            const select = document.getElementById('centro-select');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
            loadCentroData();
        }

        function clearCentros() {
            const select = document.getElementById('centro-select');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
            // Dejar el primero seleccionado por defecto o limpiar
            if (select.options.length > 0) select.options[0].selected = true;
            loadCentroData();
        }

        function updateDashboard(data) {
            document.getElementById('kpi-total').innerText = data.kpis.total_carga.toLocaleString();
            document.getElementById('kpi-media').innerText = data.kpis.media_carga.toLocaleString();
            document.getElementById('kpi-centros').innerText = data.kpis.num_centros;
            document.getElementById('last-update').innerText = `√öltimo Dato: ${data.ultima_fecha || '--'}`;
            document.getElementById('settings-last-update').innerText = data.ultima_fecha || '-';
            document.getElementById('settings-total-records').innerText = data.evolucion_total.fechas.length + ' d√≠as';

            Object.values(charts).forEach(c => c.destroy && c.destroy());
            charts = {};

            const ctxTrend = document.getElementById('mainTrendChart').getContext('2d');

            // Calcular media de cargas
            const cargas = data.evolucion_total.cargas;
            const mediaCarga = cargas.reduce((sum, val) => sum + val, 0) / cargas.length;
            const lineaMedia = cargas.map(() => mediaCarga);

            charts.trend = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: data.evolucion_total.fechas,
                    datasets: [
                        {
                            label: 'Carga Total',
                            data: cargas,
                            borderColor: '#E30613',
                            backgroundColor: 'rgba(227, 6, 19, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 2,
                            order: 2
                        },
                        {
                            label: 'Media: ' + mediaCarga.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 }),
                            data: lineaMedia,
                            borderColor: '#3B5924',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [8, 4],
                            pointRadius: 0,
                            fill: false,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#B0B0B0',
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#B0B0B0' } },
                        x: { grid: { display: false }, ticks: { color: '#B0B0B0', maxTicksLimit: 10 } }
                    }
                }
            });

            const ctxMulti = document.getElementById('multiCenterChart').getContext('2d');
            const colors = ['#E30613', '#FF4D4D', '#A1050D', '#808080', '#505050'];
            const datasets = Object.keys(data.evolucion_centros).map((centro, i) => ({
                label: `Centro ${centro}`,
                data: data.evolucion_centros[centro].cargas,
                borderColor: colors[i % colors.length],
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 0
            }));

            charts.multi = new Chart(ctxMulti, {
                type: 'line',
                data: { labels: data.evolucion_total.fechas, datasets },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#B0B0B0' } } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#B0B0B0' } },
                        x: { grid: { display: false }, ticks: { color: '#B0B0B0', maxTicksLimit: 10 } }
                    }
                }
            });

            const ctxDonut = document.getElementById('centersDonutChart').getContext('2d');
            const topCentros = Object.keys(data.evolucion_centros);
            const totals = topCentros.map(c => data.evolucion_centros[c].cargas.reduce((a, b) => a + b, 0));

            charts.donut = new Chart(ctxDonut, {
                type: 'doughnut',
                data: {
                    labels: topCentros.map(c => `Centro ${c}`),
                    datasets: [{ data: totals, backgroundColor: colors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#B0B0B0', font: { size: 11 } } } },
                    cutout: '65%',
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const centerLabel = charts.donut.data.labels[index];
                            const centroId = centerLabel.replace('Centro ', '');
                            updateMainEvolutionChart(centroId);
                        }
                    },
                    onHover: (evt, elements) => {
                        evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            const tableBody = document.getElementById('ranking-body');
            tableBody.innerHTML = '';
            const rankingsCentros = data.rankings.filter(r => r.Tipo === 'Centro');
            rankingsCentros.slice(0, 15).forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'row-expandable';
                tr.id = `ranking-row-${row.Centro}`;
                tr.dataset.centroId = row.Centro;

                // Acci√≥n combinada: Actualizar gr√°fico Y expandir/colapsar art√≠culos
                tr.onclick = () => {
                    updateMainEvolutionChart(row.Centro);
                    toggleCentroArticulos(row.Centro, tr);
                };

                tr.innerHTML = `
                    <td style="font-weight:700;color:var(--rpk-red)">
                        <span class="expand-icon" title="Ver art√≠culos">‚ñ∂</span>#${row.Ranking}
                    </td>
                    <td>${row.Centro}</td>
                    <td>${(row.Carga_Dia || 0).toFixed(2)}</td>
                    <td style="color:var(--text-muted)">${(row.Media_Mensual || 0).toFixed(2)}</td>
                    <td style="color:var(--text-muted)">${(row.Total_Mes || 0).toFixed(2)}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        async function updateMainEvolutionChart(centroId) {
            // Resaltar fila
            document.querySelectorAll('.row-expandable').forEach(r => r.style.background = '');
            const selectedRow = document.getElementById(`ranking-row-${centroId}`);
            if (selectedRow) selectedRow.style.background = 'rgba(227, 6, 19, 0.15)';

            try {
                const fechaInicio = document.getElementById('fecha-inicio').value;
                const fechaFin = document.getElementById('fecha-fin').value;

                let url = `/api/centro/${centroId}`;
                const params = new URLSearchParams();
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                const data = await response.json();

                if (data.error) { console.error(data.error); return; }

                // Actualizar t√≠tulo y mostrar bot√≥n reset
                document.getElementById('multi-chart-title').innerText = `Evoluci√≥n Diaria - Centro ${centroId}`;
                document.getElementById('reset-chart-btn').style.display = 'block';

                if (charts.multi) {
                    charts.multi.data.labels = data.fechas;
                    charts.multi.data.datasets = [{
                        label: `Centro ${centroId}`,
                        data: data.cargas,
                        borderColor: '#E30613',
                        backgroundColor: 'rgba(227, 6, 19, 0.15)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 3,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }];
                    charts.multi.update();
                }
            } catch (error) {
                console.error("Error al actualizar gr√°fico:", error);
            }
        }

        function resetToTop5Centers() {
            if (globalData) {
                document.getElementById('multi-chart-title').innerText = 'Evoluci√≥n por Centros Principales';
                document.getElementById('reset-chart-btn').style.display = 'none';
                document.querySelectorAll('.row-expandable').forEach(r => r.style.background = '');

                const data = globalData;
                const colors = ['#E30613', '#FF4D4D', '#A1050D', '#808080', '#505050'];
                const datasets = Object.keys(data.evolucion_centros).map((centro, i) => ({
                    label: `Centro ${centro}`,
                    data: data.evolucion_centros[centro].cargas,
                    borderColor: colors[i % colors.length],
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 0
                }));

                if (charts.multi) {
                    charts.multi.data.labels = data.evolucion_total.fechas;
                    charts.multi.data.datasets = datasets;
                    charts.multi.update();
                }
            }
        }

        async function toggleCentroArticulos(centroId, row) {
            const isExpanded = row.classList.contains('expanded');

            // Cerrar otros si se desea (opcional)
            // document.querySelectorAll('.expanded').forEach(r => r.classList.remove('expanded'));

            if (isExpanded) {
                row.classList.remove('expanded');
                const nextRow = row.nextElementSibling;
                if (nextRow && nextRow.classList.contains('child-row')) {
                    nextRow.remove();
                }
            } else {
                row.classList.add('expanded');

                // Mostrar cargando
                const loadingRow = document.createElement('tr');
                loadingRow.className = 'child-row';
                loadingRow.innerHTML = `
                    <td colspan="5">
                        <div class="child-container" style="color: var(--text-muted); font-size: 0.75rem; padding: 0.5rem 3rem;">
                            Cargando art√≠culos...
                        </div>
                    </td>
                `;
                row.insertAdjacentElement('afterend', loadingRow);

                try {
                    const fecha = document.getElementById('fecha-fin').value || globalData.ultima_fecha;
                    const response = await fetch(`/api/centro/${centroId}/articulos?fecha=${fecha}`);
                    const data = await response.json();

                    if (!data.articulos || data.articulos.length === 0) {
                        loadingRow.innerHTML = `
                            <td colspan="5">
                                <div class="child-container" style="color: var(--text-muted); font-size: 0.75rem; padding: 0.5rem 3rem;">
                                    No hay detalles de art√≠culos para esta fecha.
                                </div>
                            </td>
                        `;
                    } else {
                        const hasOF = data.articulos.length > 0 && 'OF' in data.articulos[0];

                        let articlesHtml = `
                            <table class="article-table">
                                <thead>
                                    <tr>
                                        <th>Art√≠culo</th>
                                        ${hasOF ? '<th>O.F.</th>' : ''}
                                        <th style="text-align: right;">Horas</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.articulos.forEach(art => {
                            articlesHtml += `
                                <tr>
                                    <td>${art.Articulo}</td>
                                    ${hasOF ? `<td>${art.OF || '-'}</td>` : ''}
                                    <td style="text-align: right; font-weight: 600;">${art.Horas.toFixed(2)}</td>
                                </tr>
                            `;
                        });

                        articlesHtml += `</tbody></table>`;

                        loadingRow.innerHTML = `
                            <td colspan="5">
                                <div class="child-container">
                                    <div style="margin-bottom: 0.5rem; font-weight: 600; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">
                                        Desglose por Art√≠culo
                                    </div>
                                    ${articlesHtml}
                                </div>
                            </td>
                        `;
                    }
                } catch (err) {
                    loadingRow.innerHTML = `<td colspan="5"><div class="child-container" style="color: var(--rpk-red);">Error al cargar datos</div></td>`;
                }
            }
        }

        function applyFilters() {
            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;
            loadSummary(fechaInicio, fechaFin);
        }

        function resetFilters() {
            fetch('/api/fechas').then(r => r.json()).then(data => {
                document.getElementById('fecha-inicio').value = data.fecha_min;
                document.getElementById('fecha-fin').value = data.fecha_max;
                loadSummary();
            });
        }

        async function loadCentroData() {
            const select = document.getElementById('centro-select');
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);

            if (selectedOptions.length === 0) {
                alert('Selecciona al menos un centro');
                return;
            }

            const centroIds = selectedOptions.join(',');
            const fechaInicio = document.getElementById('centro-fecha-inicio').value;
            const fechaFin = document.getElementById('centro-fecha-fin').value;

            let url = `/api/centro/${centroIds}`;
            const params = new URLSearchParams();
            if (fechaInicio) params.append('fecha_inicio', fechaInicio);
            if (fechaFin) params.append('fecha_fin', fechaFin);
            if (params.toString()) url += '?' + params.toString();

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) { alert(data.error); return; }

                document.getElementById('centro-content').style.display = 'block';

                // Actualizar KPIs Globales de la selecci√≥n
                document.getElementById('centro-total').innerText = data.stats_globales.total.toLocaleString();
                document.getElementById('centro-media').innerText = data.stats_globales.media.toLocaleString();
                document.getElementById('centro-max').innerText = data.stats_globales.max.toLocaleString();
                document.getElementById('centro-min').innerText = data.stats_globales.min.toLocaleString();

                // Actualizar Gr√°fico Principal
                if (charts.centro) charts.centro.destroy();
                const ctx = document.getElementById('centroEvolutionChart').getContext('2d');

                const datasets = [];
                const colors = ['#E30613', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c', '#7f8c8d'];

                let i = 0;
                for (const [cid, cdata] of Object.entries(data.centros)) {
                    const color = colors[i % colors.length];
                    datasets.push({
                        label: `Centro ${cid}`,
                        data: cdata.cargas,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        fill: selectedOptions.length === 1,
                        tension: 0.3,
                        pointRadius: selectedOptions.length === 1 ? 3 : 0
                    });
                    i++;
                }

                charts.centro = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.fechas,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { display: true, position: 'top', labels: { color: '#B0B0B0', font: { size: 10 } } }
                        },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#B0B0B0' } },
                            x: { grid: { display: false }, ticks: { color: '#B0B0B0', maxTicksLimit: 12 } }
                        }
                    }
                });

                // Actualizar Hist√≥rico Mensual (Agregado o por Centro si es uno solo)
                if (charts.centroMonthly) charts.centroMonthly.destroy();
                const ctxMonthly = document.getElementById('centroMonthlyChart').getContext('2d');

                // Para el mensual, si hay muchos centros, mostramos el total acumulado de la selecci√≥n
                const monthlyData = {};
                for (const cid in data.centros) {
                    const cdata = data.centros[cid];
                    cdata.fechas.forEach((f, idx) => {
                        const mes = f.substring(0, 7);
                        if (!monthlyData[mes]) monthlyData[mes] = 0;
                        monthlyData[mes] += cdata.cargas[idx];
                    });
                }

                const meses = Object.keys(monthlyData).sort();
                const valores = meses.map(m => monthlyData[m]);

                charts.centroMonthly = new Chart(ctxMonthly, {
                    type: 'bar',
                    data: {
                        labels: meses,
                        datasets: [{
                            label: 'Carga Total Selecci√≥n',
                            data: valores,
                            backgroundColor: '#E30613',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#B0B0B0' } },
                            x: { grid: { display: false }, ticks: { color: '#B0B0B0' } }
                        },
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const mes = meses[index];
                                loadMonthlyBreakdown(mes);
                            }
                        },
                        onHover: (evt, elements) => {
                            evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                        }
                    }
                });

                // Ocultar desglose mensual anterior al recargar
                document.getElementById('monthly-breakdown-container').style.display = 'none';

            } catch (err) {
                console.error(err);
                alert('Error al cargar datos de los centros');
            }
        }

        async function loadMonthlyBreakdown(mes) {
            const select = document.getElementById('centro-select');
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);
            const centroIds = selectedOptions.join(',');

            const container = document.getElementById('monthly-breakdown-container');
            const tableContainer = document.getElementById('monthly-breakdown-table-container');
            const title = document.getElementById('monthly-breakdown-title');

            container.style.display = 'block';
            title.innerText = `Cargando Desglose para ${mes}...`;
            tableContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">Cargando datos detallados...</div>';

            try {
                const response = await fetch(`/api/centro/${centroIds}/articulos/mes/${mes}`);
                const data = await response.json();

                if (data.error || !data.articulos || data.articulos.length === 0) {
                    tableContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--rpk-red);">No se encontraron datos para este periodo.</div>';
                    return;
                }

                title.innerText = `Desglose de Art√≠culos - ${mes} (${data.total_horas.toLocaleString()}h totales)`;

                const hasOF = data.articulos.length > 0 && 'of' in data.articulos[0];

                let html = `
                    <table class="article-table">
                        <thead>
                            <tr>
                                <th>Art√≠culo</th>
                                ${hasOF ? '<th>O.F.</th>' : ''}
                                <th style="text-align: right;">D√≠as</th>
                                <th style="text-align: right;">% s/Carga Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.articulos.forEach(art => {
                    html += `
                        <tr>
                            <td>${art.articulo}</td>
                            ${hasOF ? `<td>${art.of || '-'}</td>` : ''}
                            <td style="text-align: right; font-weight: 600;">${art.dias}</td>
                            <td style="text-align: right;">
                                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                    <div style="width: 60px; height: 6px; background: var(--dark-surface-2); border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${art.porcentaje}%; height: 100%; background: var(--rpk-red);"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted); min-width: 45px;">${art.porcentaje}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
                tableContainer.innerHTML = html;

                // Scroll suave hasta el desglose
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (err) {
                console.error(err);
                tableContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--rpk-red);">Error al cargar el desglose.</div>';
            }
        }

        window.onload = fetchData;
    </script>
</body>

</html>